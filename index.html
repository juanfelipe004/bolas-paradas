  <!doctype html>
  <html lang="pt-BR">
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" href="bahia.png" type="png">
  <link rel="apple-touch-icon" href="bahia.png">
  <title>Marcador de Bolas Paradas</title>
  <style>

    #appFooter {
  width: 100%;
  text-align: center;
  padding: 10px 0;
  font-size: 13px;
  color: var(--text-secondary);
  margin-top: 20px;
  user-select: none;
}
 /* ================================
   FONTE / TEMA BAHIA MODERNO
=============================== */
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');

:root {
  --white: #ffffff;
  --bg: #EEF2F7;
  --panel: #ffffff;
  --panel-soft: #F7F9FC;

  --border: #D3DAE4;
  --border-dark: #B3BBC8;
  --border-strong: #8A93A3;

  --text: #1D1E22;
  --text-secondary: #5D6472;

  --primary: #002A6E;
  --primary-dark: #001C49;
  --primary-soft: #E3ECFF;

  --accent: #E10600;
  --success: #16A34A;
  --warn: #D61B1B;

  --hover: #F1F4FB;
  --focus: #D6E3FF;

  --radius: 8px;
  --radius-lg: 10px;
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.10);
  --shadow-md: 0 4px 12px rgba(0,0,0,0.12);

  --transition: .22s cubic-bezier(.22,.61,.36,1);

  --space-4: 4px;
  --space-8: 8px;
  --space-12: 12px;
  --space-16: 16px;
  --space-20: 20px;
  --space-24: 24px;
}

/* ================================
   GLOBAL
=============================== */
body {
  font-family: 'Inter', Arial, sans-serif;
  margin: 0;
  padding: var(--space-12);
  background: var(--bg);
  color: var(--text);
  font-size: 14px;
  -webkit-font-smoothing: antialiased;
}

/* ================================
   BRAND BAR CENTRALIZADO
=============================== */
#brandBar {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  padding: var(--space-12) 0 var(--space-8) 0;
  border-bottom: 1px solid var(--border);
  margin-bottom: 12px;
}

#brandLogo {
  width: 60px;
  height: 60px;
  background-image: url('bahia.png');
  background-size: contain;
  background-repeat: no-repeat;
  background-position: center;
  filter: drop-shadow(0 2px 4px rgba(0,0,0,0.16));
}

#brandInfo {
  display: flex;
  flex-direction: column;
  justify-content: center;
  gap: 2px;
}

#brandTitle {
  font-weight: 600;
  font-size: 19px;
  color: var(--primary-dark);
}

#brandSub {
  font-size: 13px;
  color: var(--text-secondary);
}

/* ================================
    HEADERS
=============================== */
h2 {
  text-align: center;
  font-weight: 600;
  font-size: 20px;
  margin-bottom: 2px;
}

h2 + div {
  text-align: center;
  color: var(--text-secondary);
  font-size: 13px;
  margin-bottom: var(--space-12);
}

h4 {
  text-align: center;
  margin: 0 0 6px 0;
  color: var(--primary-dark);
  font-weight: 600;
}

/* ================================
   TOOLBAR
=============================== */
.toolbar {
  display: flex;
  gap: var(--space-8);
  flex-wrap: wrap;
  margin-bottom: var(--space-16);
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: var(--space-12);
  box-shadow: var(--shadow-sm);
}

/* ================================
   BOT√ïES E INPUTS
=============================== */
button, select, input[type="text"], input[type="number"] {
  padding: var(--space-8) var(--space-12);
  border-radius: var(--radius);
  border: 1px solid var(--border-dark);
  font-size: 14px;
  background: var(--white);
  cursor: pointer;
  transition: var(--transition);
}

/* prim√°rio */
button {
  background: var(--primary);
  border-color: var(--primary);
  color: var(--white);
  font-weight: 500;
}
button:hover {
  background: var(--primary-dark);
  transform: translateY(-1px);
  box-shadow: var(--shadow-sm);
}
button:active {
  transform: scale(.98);
}

/* secund√°rio */
button.btn-small,
button[style*="Excluir"],
button[style*="Cancelar"] {
  background: var(--panel-soft);
  border: 1px solid var(--border-dark);
  color: var(--text);
}
button.btn-small:hover,
button[style*="Cancelar"]:hover {
  background: var(--hover);
}

/* delete */
button[style*="color:#900"],
button[style*="Excluir"] {
  color: var(--warn) !important;
}
button[style*="Excluir"]:hover {
  background: #ffe6e6 !important;
}

/* selects e inputs */
select:hover, input:hover {
  background: var(--hover);
}
/* DESATIVA OUTLINE PERSISTENTE */
button:focus,
select:focus,
input:focus {
  outline: none;
  box-shadow: 0 0 0 3px var(--focus);
}

/* EVITA FOCUS PRESO AP√ìS O CLICK */
button:focus-visible {
  box-shadow: 0 0 0 3px var(--focus);
}

button:focus:not(:focus-visible) {
  box-shadow: none;
}


/* ================================
   MAPAS E PAIN√âIS
=============================== */
#mapColumn {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: var(--space-12);
  box-shadow: var(--shadow-sm);
}

/* pain√©is padr√£o */
.panel {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: var(--space-12);
  box-shadow: var(--shadow-sm);
  transition: var(--transition);
}

.panel:hover {
  box-shadow: var(--shadow-md);
}

/* painel com altura fixa */
.panel2 {
  height: 164px;
}

/* imagens internas */
.panel img {
  width: 100%;
  height: auto;
  border-radius: var(--radius);
  object-fit: contain;
}

/* cart√µes com scroll */
.scroll-card {
  max-height: 225px;
  overflow-y: auto;
}

/* ================================
   PONTOS MARCADOS (LISTA)
=============================== */
.point-row {
  display: flex;
  flex-direction: column;
  padding: 10px 0;
  border-bottom: 1px dashed var(--border);
  transition: var(--transition);
  cursor: pointer;
}
.point-row:hover {
  background: var(--hover);
  padding-left: 4px;
}

.point-row .main-line {
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 14px;
  font-weight: 500;
}

.point-row .row-actions {
  margin-left: auto;
  display: flex;
  gap: 6px;
}

.point-row .coords {
  font-size: 12px;
  color: var(--text-secondary);
  margin-left: 24px;
  margin-top: 2px;
}

/* ================================
   STATS GRID
=============================== */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: var(--space-12);
}

@media (max-width: 1440px) {
  .stats-grid { grid-template-columns: repeat(3, 1fr); }
}
@media (max-width: 900px) {
  .stats-grid { grid-template-columns: repeat(2, 1fr); }
}
@media (max-width: 600px) {
  .stats-grid { grid-template-columns: repeat(1, 1fr); }
}

.stats-block {
  background: linear-gradient(180deg, var(--panel), var(--panel-soft));
  padding: var(--space-12);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-sm);
  white-space: pre-line;
  line-height: 1.4;
  transition: var(--transition);
}
.stats-block:hover {
  box-shadow: var(--shadow-md);
  transform: translateY(-2px);
}

/* check stats */
.stat-line {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 2px 0;
}
.stat-text {
  line-height: 18px;
}
.stat-check {
  width: 16px;
  height: 16px;
  cursor: pointer;
  accent-color: var(--primary);
}

/* ================================
   MODAL
=============================== */
.overlay {
  position: fixed !important;
  inset: 0;
  background: rgba(0,0,0,0.45) !important;
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 99999;
  backdrop-filter: blur(2px);
}

.modal {
  background: var(--white);
  width: 540px;
  max-height: 90vh;
  overflow-y: auto;
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-md);
  border: 1px solid var(--border);
  animation: modalIn .28s var(--transition);
}

.modal .header {
  padding: var(--space-12);
  border-bottom: 1px solid var(--border);
  font-weight: 600;
  font-size: 15px;
  color: var(--primary-dark);
}

@keyframes modalIn {
  from { opacity: 0; transform: scale(.92);}
  to   { opacity: 1; transform: scale(1);}
}

/* tabs */
.tabs {
  display: flex;
  border-bottom: 1px solid var(--border);
}
.tab {
  flex: 1;
  padding: var(--space-8);
  text-align: center;
  cursor: pointer;
  background: var(--panel-soft);
  font-weight: 500;
  border-right: 1px solid var(--border);
  user-select: none;
  transition: var(--transition);
}
.tab:hover {
  background: var(--hover);
}
.tab.active {
  background: var(--white);
  border-bottom: 2px solid var(--primary);
  color: var(--primary-dark);
}

.tab-content {
  display: none;
  padding: var(--space-12);
  font-size: 14px;
}
.tab-content.active {
  display: block;
}

/* MODAL ROWS */
.row {
  display: flex;
  align-items: center;
  margin-bottom: var(--space-12);
  gap: var(--space-8);
}
.actions {
  display: flex;
  justify-content: flex-end;
  gap: var(--space-8);
  padding: var(--space-12);
  border-top: 1px solid var(--border);
}

/* ================================
   RESPONSIVO
=============================== */
@media (max-width: 1080px) {
  #layoutRow { flex-direction: column; }
  #rightColumn { flex-direction: column; }
}
@media (max-width: 720px) {
  .toolbar { padding: var(--space-8); }
}

  </style>
  </head>
  <body>

  <div id="brandBar" style="margin-bottom: 10px; padding-top: 2px !important;">
    <div id="brandLogo"></div>
    <div id="brandInfo">
      <div id="brandTitle">Esporte Clube Bahia SAF</div>
      <div id="brandSub">Categoria de base ‚Ä¢ Temporada 2026</div>
    </div>
  </div>



  <div class="toolbar">
    <button id="btnClear">Limpar pontos</button>
    <button id="btnUndo">Desfazer</button>
    <button id="btnExportCSV">Exportar CSV</button>
    <button id="btnExportPNG">Exportar PNG</button>
    <button id="btnExportPDF">Exportar PDF</button>
    <label for="importCSV" style="padding:10px 10px; background:#0077cc; color:white; cursor:pointer; border-radius:4px; font-size:13px;">
      CSV IMPORT
    </label>
    <input type="file" id="importCSV" accept=".csv" multiple style="display:none;" />
  <button id="btnClearStatsFilters">Limpar filtros</button>



    <div style="margin-left:12px;">
      <button id="btnHeatmapToggle">Heatmap: OFF</button>
      <label style="margin-left:8px;">Mostrar: </label>
      <select id="filterShow">
        <option value="both">Ambos</option>
        <option value="ofensivo">Apenas ofensivos</option>
        <option value="defensivo">Apenas defensivos</option>
      </select>

      <!-- FILTRO NOVO BP -->
      <label style="margin-left:8px;">BP:</label>
      <select id="filterBP">
        <option value="all">Todos</option>
        <option value="escanteio">Escanteio</option>
        <option value="faltaIndireta">Falta indireta</option>
      </select>
    </div>
    <label style="margin-left:8px; margin-top: 9px;">Lado:</label>
  <select id="filterLado">
    <option value="all">Todos</option>
    <option value="direito">Direito</option>
    <option value="esquerdo">Esquerdo</option>
    <option value="central">Central</option>
  </select>
  <button id="btnHelp" style="margin-left:auto; background-color: red;">Manual</button>

  </div>
  


  <div style="display:flex; gap:16px; align-items:flex-start;">

    <!-- MAPA -->
    <div id="mapContainer" style="flex:1; display:flex; justify-content:center;">
      
    </div>

    <div id="layoutRow" style="
    display:flex;
    align-items:flex-start;
    width:100%;
  ">

    <!-- MAPA (GRUDADO ESQUERDA) -->
    <div id="mapColumn" style="flex:0 0 auto; margin-right:15px; margin-top: 45px;">
      <canvas id="canvas" width="1200" height="600"></canvas>
    </div>

    <!-- AREA DIREITA (FLEXIBLE) -->
    <div id="rightColumn" style="
    display:grid;
    grid-template-columns: 260px 260px;
    grid-template-rows: auto auto;
    gap:15px;
    margin-top: 20px;
  ">
  <!-- LEGENDA (COLADA) -->
      <div style="width:260px;">
        <h4>Legenda</h4>
        <div class="panel">
          <div><span class="swatch" style="background:#0033aa"></span> Azul escuro = viajada</div>
    <div><span class="swatch" style="background:#cc0000"></span> Vermelho = r√°pida</div>
    <div><span class="swatch" style="background:#ffcc00"></span> Amarelo = curta</div>
    <div>‚≠ê Gol</div>
    <div>‚óè Sem gol</div>
    <div>‚ö†Ô∏è Chance clara</div>
    <div style="display:flex; align-items:center; gap:6px;">
        <div style="width:14px;height:14px;border:2px solid #000;border-radius:50%;"></div>
        Contorno preto = finalizou
    </div>
    <div>Letras D/E/C indicam lado da cobran√ßa</div>
        </div>
      </div>
      <!-- FINALIZA√á√ÉO (COLADA) -->
  <div style="width:260px;">
    <h4>Finaliza√ß√£o no gol</h4>
  <div class="panel panel2">
    <canvas id="goalViewCanvas" width="240" height="150"></canvas>
  </div>
  </div>
  <!-- COBRADORES -->
    <div>
      <h4>Cobradores ECB</h4>
      <div id="cobradoresCard" class="panel scroll-card"></div>
    </div>

    <!-- JOGADORES -->
    <div>
      <h4>Jogadores ECB</h4>
      <div id="jogadoresCard" class="panel scroll-card"></div>
    </div>
    </div>

<div style="margin-top:20px; width:25%; margin-left: 10px;">
  <h4 style="margin:0; text-align:center;">Tomada de Decis√£o</h4>

  <div id="decisionPanel"
       class="panel"
       style="max-height:450px; overflow:auto; margin-top:10px;">
    Carregando an√°lises...
  </div>
</div>





    <!-- LISTA PONTOS (CIMA) -->
      <div style="flex:1; max-width:calc(100% - 260px);margin-top: 20px; margin-left: 10px;">
        <div style="display:flex; justify-content:space-between; align-items:center; cursor:pointer;">
          <h4 style="margin:0;">Pontos Marcados</h4>
         
        </div>

        <div id="pointsPanel" class="panel" style="max-height:450px; overflow:auto; margin-top:6px;">
          <div id="pointsList"></div>
        </div>
      </div>
  </div>


  </div>

  <!-- ESTAT√çSTICAS EMBAIXO -->
  <div style="margin-top:20px;">
    <div id="statsPanel" class="panel muted">Nenhum dado</div>
  </div>


  <!-- MODAL -->
  <div id="overlay" class="overlay">
    <div class="modal">
      <div class="header">Editar / Criar ponto</div>

      <div class="tabs">
        <div class="tab active" data-tab="tab-geral">Geral</div>
        <div class="tab" data-tab="tab-final">Finaliza√ß√£o</div>
        <div class="tab" data-tab="tab-resultado">Resultado</div>
        <div class="tab" data-tab="tab-avanc">Avan√ßado</div>
      </div>

      <div id="tab-geral" class="tab-content active">

        <!-- NOVO CAMPO -->
        <div class="row"><label>Bola parada:</label>
          <select id="tipoBP">
            <option value="escanteio">Escanteio</option>
            <option value="faltaIndireta">Falta indireta</option>
          </select>
        </div>
        <!-- FIM NOVO CAMPO -->

        <div class="row"><label>Tipo:</label>
          <select id="tipoExec"><option value="viajada">Viajada</option><option value="rapida">R√°pida</option><option value="curta">Curta</option></select>
        </div>
        <div class="row"><label>Lado:</label>
          <select id="ladoExec"><option value="direito">Direito</option><option value="esquerdo">Esquerdo</option><option value="central">Central</option></select>
        </div>
        <div class="row"><label>Abertura:</label>
          <select id="abertura"><option value="aberta">Aberta</option><option value="fechada">Fechada</option></select>
        </div>
        <div class="row"><label>1¬∫ contato:</label>
          <select id="primeiroContato"><option value="nosso">Nosso</option><option value="adversario">Advers√°rio</option><option value="goleiro">Goleiro advers√°rio</option></select>
        </div>
        <div class="row"><label>2¬™ bola?</label>
          <select id="segundaBola">
    <option value="nao">N√£o</option>
    <option value="nossa">nossa</option>
    <option value="adversario">advers√°rio</option>
  </select>

        </div>
        <div class="row"><label>Quem cobrou:</label>
          <input id="quemCobrou" style="flex:1" />
        </div>
        <div class="row"><label>Situa√ß√£o:</label>
          <select id="situacao"><option value="ofensiva">Ofensiva</option><option value="defensiva">Defensiva</option></select>
        </div>
        <div class="row"><label><input id="cobFora" type="checkbox" /> Cobran√ßa para fora do campo</label></div>
        <div class="row">
          <label><input id="teveGol" type="checkbox" /> Teve gol</label>
          <label><input id="finalizou" type="checkbox" /> Finalizou</label>
          <label><input id="teveFalha" type="checkbox" /> Falha</label>
        </div>
      </div>

      <div id="tab-final" class="tab-content">
        <div class="row">
    <label>Finaliza√ß√£o de:</label>
    <select id="finalizacaoTipo">
      <option value="">‚Äî</option>
      <option value="pe">P√©</option>
      <option value="cabeca">Cabe√ßa</option>
    </select>
  </div>

  <div class="row" id="rowQuemFinalizou" style="display:none;">
    <label>Quem finalizou:</label>
    <input id="quemFinalizou" style="flex:1" placeholder="Nome do jogador" />
  </div>

  <div class="row">
    <label>Qualidade:</label>
    <select id="qualidadeChance">
      <option value="">‚Äî</option>
      <option value="clara">Chance clara</option>
      <option value="boa">Boa</option>
      <option value="ruim">Ruim</option>
    </select>
  </div>

        <div class="row"><label>Altura:</label>
          <select id="altura"><option value="">‚Äî</option><option value="rasteira">Rasteira</option><option value="media">M√©dia</option><option value="alta">Alta</option></select>
        </div>
        <div class="row"><label><input id="finalForaArea" type="checkbox" /> Finaliza√ß√£o fora da √°rea</label></div>
      </div>

      <div id="tab-resultado" class="tab-content">
        <div class="row"><label>Resultado:</label>
          <select id="resultadoJogada"><option value="">‚Äî</option><option value="gol">Gol</option><option value="contraAtaque">Contra-ataque</option><option value="fora">Finaliza√ß√£o para fora</option><option value="noGol">Finaliza√ß√£o no gol</option><option value="bloqueada">Bloqueada</option><option value="corte">Corte</option><option value="nada">Nada</option></select>
        </div>
        <div id="goalEditWrapper" style="margin-top:14px; display:none;">
    <label><b>Local da finaliza√ß√£o</b></label>
    <canvas id="goalEditCanvas" width="240" height="160"
            style="margin-top:6px; border:1px solid #ccc; border-radius:6px;">
    </canvas>
  </div>


      </div>

      <div id="tab-avanc" class="tab-content">
        <div class="row"><label>Falha?</label>
          <select id="falhaSelect"><option value="">‚Äî</option><option value="sim">Sim</option><option value="nao">N√£o</option></select>
        </div>
      </div>

      <div class="actions">
        <button id="deletePoint" class="btn-small" style="margin-right:auto; color:#900;">Excluir</button>
        <button id="cancelModal" class="btn-small">Cancelar</button>
        <button id="confirmModal" class="btn-small">Salvar</button>
      </div>
    </div>
  </div>

  <script>
  /* ======== CORE STATE ======== */
  const COLORS={viajada:"#0033aa",rapida:"#cc0000",curta:"#ffcc00"};
  const CLARA_COLORS = {
    viajada: "#0033aa",
    rapida: "#e74c3c",    
    curta: "#f1c40f"      
  };



  const canvas=document.getElementById('canvas');
  const ctx=canvas.getContext('2d');
  let img=new Image(), imgLoaded=false;
  let points=[];
  let pendingClick=null;
  let editingIndex=null;
  let heatmapOn=false;
  let filterShow='both';
  let filterBP='all'; // NOVO
  let filterLado='all';

  // === NOVOS FILTROS DP ===
let filterCobradores = new Set();
let filterJogadores = new Set();



  // === FILTROS INTERNOS (estat√≠sticas) ===
  // l√≥gica: (AND entre grupos) e (OR dentro do grupo)
  let statFilters = {};

  function ensureGroup(group){
    if(!statFilters[group]) statFilters[group] = new Set();
  }

  function passesStatFilters(p){
    for(const group in statFilters){
      const set = statFilters[group];
      if(set.size === 0) continue;

      const value = p[group];
      if(!set.has(String(value))) return false;
    }
    return true;
  }


  /* ======== HEATMAP REGIONS ======== */
  const HEAT_REGIONS=[
    {name:"primeiro",x1:253,x2:361,y1:40,y2:150},
    {name:"zona",x1:362,x2:465,y1:40,y2:150},
    {name:"segundo",x1:466,x2:588,y1:40,y2:150}
  ];

  /* ======== ELEMENTS ======== */
  const filterSelect=document.getElementById('filterShow');
  const filterBPSelect=document.getElementById('filterBP'); // NOVO
  const btnHeatmapToggle=document.getElementById('btnHeatmapToggle');
  const btnClear=document.getElementById('btnClear');
  const btnUndo=document.getElementById('btnUndo');
  const btnExportCSV=document.getElementById('btnExportCSV');
  const btnExportPNG=document.getElementById('btnExportPNG');
  const pointsList=document.getElementById('pointsList');
  const statsPanel=document.getElementById('statsPanel');
  const overlay=document.getElementById('overlay');
  const filterLadoSelect=document.getElementById('filterLado');


  /* MODAL FIELDS */
  const quemFinalizou = document.getElementById('quemFinalizou');
  const rowQuemFinalizou = document.getElementById('rowQuemFinalizou');
  const tipoBP=document.getElementById('tipoBP'); // NOVO
  const tipoExec=document.getElementById('tipoExec');
  const ladoExec=document.getElementById('ladoExec');
  const abertura=document.getElementById('abertura');
  const primeiroContato=document.getElementById('primeiroContato');
  const segundaBola=document.getElementById('segundaBola');
  const quemCobrou=document.getElementById('quemCobrou');
  const situacao=document.getElementById('situacao');
  const cobFora=document.getElementById('cobFora');
  const teveGol=document.getElementById('teveGol');
  const finalizou=document.getElementById('finalizou');
  const teveFalha=document.getElementById('teveFalha');
  const finalizacaoTipo=document.getElementById('finalizacaoTipo');
  const qualidadeChance=document.getElementById('qualidadeChance');
  const altura=document.getElementById('altura');
  const finalForaArea=document.getElementById('finalForaArea');
  const resultadoJogada=document.getElementById('resultadoJogada');
  const falhaSelect=document.getElementById('falhaSelect');
  const confirmModal=document.getElementById('confirmModal');
  const cancelModal=document.getElementById('cancelModal');
  const deletePoint=document.getElementById('deletePoint');

  /* TABS */
  document.querySelectorAll('.tab').forEach(t=>{
    t.onclick=()=>{
      document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
      t.classList.add('active');
      document.getElementById(t.dataset.tab).classList.add('active');
    }
  });

  /* LOAD DEFAULT IMAGE */
  img.onload=()=>{
    canvas.width=img.naturalWidth;
    canvas.height=img.naturalHeight;
    imgLoaded=true;
    render();
  };
  img.src="picture1.png";

  /* RESET */
  function resetModal(){
    tipoBP.value='escanteio'; // NOVO
    tipoExec.value='viajada';
    ladoExec.value='direito';
    abertura.value='aberta';
    primeiroContato.value='nosso';
    segundaBola.value='nao';
    quemCobrou.value='';
    situacao.value='ofensiva';
    cobFora.checked=false;
    teveGol.checked=false;
    finalizou.checked=false;
    teveFalha.checked=false;
    finalizacaoTipo.value='';
    qualidadeChance.value='';
    altura.value='';
    finalForaArea.checked=false;
    resultadoJogada.value='';
    falhaSelect.value='';
  }

  /* CLICK */
  canvas.onclick = (ev)=>{
    if(!imgLoaded) return;

    const r = canvas.getBoundingClientRect();
    const x = ev.clientX - r.left;
    const y = ev.clientY - r.top;

    const visible = getVisiblePoints(); // üëà s√≥ os vis√≠veis

    let foundIndex = null;

    for(const p of visible){
      if(Math.hypot(p.x - x, p.y - y) <= 12){
        foundIndex = points.indexOf(p); // √≠ndice real
        break;
      }
    }

    if(foundIndex !== null){
      openModalEdit(foundIndex);
      return;
    }

    editingIndex = null;
    pendingClick = { x, y };
    openModalCreate();
  };

  function openModalCreate(){
    resetModal();

    // üî¥ LINHA CR√çTICA ‚Äî RESETA O RESULTADO CORRETAMENTE
    updateResultadoOptions();

    deletePoint.style.display='none';
    overlay.style.display='flex';
    resetTabsState();
    tempGoalPoint = null;
    renderGoalEdit();
    goalEditWrapper.style.display = 'none';
  }

  function openModalEdit(i){
    editingIndex=i;
    const p=points[i];

    tipoBP.value=p.tipoBP||'escanteio'; // NOVO
    quemFinalizou.value = p.quemFinalizou || '';
  rowQuemFinalizou.style.display = p.finalizou ? 'flex' : 'none';
    tipoExec.value=p.tipo;
    ladoExec.value=p.lado;
    abertura.value=p.abertura;
    primeiroContato.value=p.primeiroContato;
    segundaBola.value=p.segundaBola;
    quemCobrou.value=p.quemCobrou||'';
    situacao.value=p.situacao;
    cobFora.checked=p.cobFora;
    teveGol.checked=p.teveGol;
    finalizou.checked=p.finalizou;
    teveFalha.checked=p.teveFalha;
    finalizacaoTipo.value=p.finalizacaoTipo||'';
    qualidadeChance.value=p.qualidadeChance||'';
    altura.value=p.altura||'';
    finalForaArea.checked=p.finalForaArea;
    resultadoJogada.value=p.resultadoJogada||'';
    falhaSelect.value=p.falha||'';
    tempGoalPoint = points[i].goalPoint || null;  
    goalEditWrapper.style.display =
    (points[i].resultadoJogada === 'gol' || points[i].resultadoJogada === 'noGol')
      ? 'block'
      : 'none';

    deletePoint.style.display='inline-block';
    overlay.style.display='flex';
    resetTabsState()
    const ativo = p.resultadoJogada === 'gol' || p.resultadoJogada === 'noGol';
  goalEditWrapper.style.display = ativo ? 'block' : 'none';
  renderGoalEdit();


  }

  cancelModal.onclick=()=>{overlay.style.display='none';pendingClick=null;editingIndex=null;tempGoalPoint = null;};
  deletePoint.onclick=()=>{ if(editingIndex!==null){points.splice(editingIndex,1);render();} overlay.style.display='none'; };

  confirmModal.onclick = ()=>{
    const data = {
      x: pendingClick ? pendingClick.x : points[editingIndex].x,
      y: pendingClick ? pendingClick.y : points[editingIndex].y,

      tipoBP: tipoBP.value,

      tipo: tipoExec.value,
      cor: COLORS[tipoExec.value],
      lado: ladoExec.value,
      abertura: abertura.value,
      primeiroContato: primeiroContato.value,
      segundaBola: segundaBola.value,
      quemCobrou: quemCobrou.value,
      situacao: situacao.value,
      cobFora: cobFora.checked,
      teveGol: teveGol.checked,
      finalizou: finalizou.checked,
      teveFalha: teveFalha.checked,
      finalizacaoTipo: finalizacaoTipo.value,
      qualidadeChance: qualidadeChance.value,
      altura: altura.value,
      finalForaArea: finalForaArea.checked,
      resultadoJogada: resultadoJogada.value,
      falha: falhaSelect.value,
      quemFinalizou: finalizou.checked ? quemFinalizou.value.trim() : '',


      // üî¥ COORDENADA DO GOL
      goalPoint: tempGoalPoint
    };

    // salva ponto normal
  if (editingIndex === null) {
    points.push(data);
  } else {
    Object.assign(points[editingIndex], data);
  }


  overlay.style.display = 'none';


  render();


  console.log('GOAL:', tempGoalPoint, resultadoJogada.value);

  };

  function drawStatsChart(){
    // placeholder para evitar erro
  }

  function getVisiblePoints(){
  return points.filter(p=>{
    if(filterShow === 'ofensivo' && p.situacao !== 'ofensiva') return false;
    if(filterShow === 'defensivo' && p.situacao !== 'defensiva') return false;
    if(filterBP !== 'all' && p.tipoBP !== filterBP) return false;
    if(filterLado !== 'all' && p.lado !== filterLado) return false;
    if(!passesStatFilters(p)) return false;

    // === NOVOS FILTROS ===
    if(filterCobradores.size > 0){
      if(!p.quemCobrou || !filterCobradores.has(p.quemCobrou)) return false;
    }

    if(filterJogadores.size > 0){
      if(!p.quemFinalizou || !filterJogadores.has(p.quemFinalizou)) return false;
    }

    return true;
  });
}




  function render(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    if(imgLoaded) ctx.drawImage(img,0,0);

    if(heatmapOn) drawHeatmap();  // 1 - heatmap
    drawPoints();                 // 2 - pontos
    if(heatmapOn) drawHeatmapText(); // 3 - texto sempre por cima

    updateUI();
    renderGoalView();
  renderPlayersCards();
    renderDecision();

  }

  function resetTabsState(){
    document.querySelectorAll('.tab').forEach(tab=>{
      const id = tab.dataset.tab;
      tab.classList.remove('active');

      // Geral e Resultado sempre liberadas
      if(id === 'tab-geral' || id === 'tab-resultado'){
        tab.style.pointerEvents = 'auto';
        tab.style.opacity = '1';
      } else {
        tab.style.pointerEvents = 'none';
        tab.style.opacity = '0.4';
      }
    });

    document.querySelectorAll('.tab-content').forEach(c=>{
      c.classList.remove('active');
    });

    // Geral sempre come√ßa ativo
    document.querySelector('.tab[data-tab="tab-geral"]').classList.add('active');
    document.getElementById('tab-geral').classList.add('active');
  }



  function enableTab(tabId){
    const tab = document.querySelector(`.tab[data-tab="${tabId}"]`);
    const content = document.getElementById(tabId);
    if(!tab || !content) return;

    // libera clique
    tab.style.pointerEvents = 'auto';
    tab.style.opacity = '1';

    // ativa visualmente
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));

    tab.classList.add('active');
    content.classList.add('active');
  }


  function drawHeatmapText(){
    const vis = points.filter(p=>{
      if(filterShow==='ofensivo' && p.situacao!=='ofensiva') return false;
      if(filterShow==='defensivo' && p.situacao!=='defensiva') return false;
      if(filterBP!=='all' && p.tipoBP!==filterBP) return false;
      if(filterLado!=='all' && p.lado!==filterLado) return false;
      if(!passesStatFilters(p)) return false;
      return true;
    });

    const counts = HEAT_REGIONS.map(r=>({
      r,
      count: vis.filter(p=>p.x>=r.x1 && p.x<=r.x2 && p.y>=r.y1 && p.y<=r.y2).length
    }));

    counts.forEach(({r,count})=>{
      if(count === 0) return;
      ctx.fillStyle='white';
      ctx.font='bold 22px Arial';
      ctx.textAlign='center';
      ctx.textBaseline='middle';
      ctx.fillText(count, r.x1+(r.x2-r.x1)/2, r.y1+(r.y2-r.y1)/2);
    });
  }

  /* HEATMAP ‚Äî corrigido */
  function drawHeatmap(){
    // pega s√≥ pontos vis√≠veis (j√° filtrados pelos filtros internos)
    const vis = points.filter(p=>{
      if(filterShow==='ofensivo' && p.situacao!=='ofensiva') return false;
      if(filterShow==='defensivo' && p.situacao!=='defensiva') return false;
      if(filterBP!=='all' && p.tipoBP!==filterBP) return false;
      if(filterLado!=='all' && p.lado!==filterLado) return false;
      if(!passesStatFilters(p)) return false;
      return true;
    });

    const counts = HEAT_REGIONS.map(r=>({
      r,
      count: vis.filter(p=>p.x>=r.x1 && p.x<=r.x2 && p.y>=r.y1 && p.y<=r.y2).length
    }));

    const max = Math.max(...counts.map(c=>c.count));

    counts.forEach(({r,count})=>{
      if(count === 0) return;
      const a = (count/max)*0.8 + 0.1; // intensidade
      ctx.fillStyle=`rgba(0,80,200,${a})`;
      ctx.fillRect(r.x1,r.y1,r.x2-r.x1,r.y2-r.y1);
    });
  }

  /* DRAW */
 function drawPoints(){
    
  for(const p of points){

    // filtro toolbar (j√° existe)
    if(filterShow==='ofensivo'&&p.situacao!=='ofensiva')continue;
    if(filterShow==='defensivo'&&p.situacao!=='defensiva')continue;
    if(filterBP!=='all' && p.tipoBP!==filterBP) continue;
    if(filterLado!=='all' && p.lado!==filterLado) continue;

    // === NOVO: filtro estat√≠stico interno ===
    if(!passesStatFilters(p)) continue;

    // === NOVO: filtro por cobrador ===
    if(filterCobradores.size > 0){
      if(!p.quemCobrou || !filterCobradores.has(p.quemCobrou)) continue;
    }

    // === NOVO: filtro por jogador (finalizador) ===
    if(filterJogadores.size > 0){
      if(!p.quemFinalizou || !filterJogadores.has(p.quemFinalizou)) continue;
    }

    ctx.fillStyle=p.cor;
    ctx.strokeStyle=p.finalizou?'#000':'transparent';
    ctx.lineWidth=2;

    if(p.cobFora){
      ctx.strokeStyle = "#cc0000";   // vermelho
      ctx.lineWidth = 6;   
      ctx.beginPath();
      ctx.moveTo(p.x-10, p.y-10);
      ctx.lineTo(p.x+10, p.y+10);
      ctx.moveTo(p.x+10, p.y-10);
      ctx.lineTo(p.x-10, p.y+10);
      ctx.stroke();
      continue;
    }

    if(p.teveGol){
      drawStar(p.x,p.y,12);
    } else if (p.qualidadeChance === 'clara') {
      drawAlertTriangle(p.x, p.y, 12, CLARA_COLORS[p.tipo], p.tipo);
      continue;
    } else {
      drawCircle(p.x,p.y,10);
    }

    ctx.font='10px Arial';
    ctx.fillStyle='white';
    ctx.textAlign='center';
    ctx.textBaseline='middle';
    const letra = p.lado ? p.lado[0].toUpperCase() : '';
    if(p.qualidadeChance !== 'clara'){
      ctx.fillText(letra,p.x,p.y);
    }

  }
}

  function drawCircle(x,y,r){
    ctx.beginPath();
    ctx.arc(x,y,r,0,Math.PI*2);
    ctx.fill();ctx.stroke();
  }
  function drawStar(x,y,r){
    ctx.beginPath();
    ctx.moveTo(x,y-r);
    ctx.lineTo(x+r*.3,y-r*.3);
    ctx.lineTo(x+r,y);
    ctx.lineTo(x+r*.3,y+r*.3);
    ctx.lineTo(x,y+r);
    ctx.lineTo(x-r*.3,y+r*.3);
    ctx.lineTo(x-r,y);
    ctx.lineTo(x-r*.3,y-r*.3);
    ctx.closePath();
    ctx.fill();ctx.stroke();
  }
  function drawTriangle(x, y, size, color){
    const h = size * 1.25; // mais altura √∫til

    ctx.beginPath();
    ctx.moveTo(x, y - h/2);       // topo
    ctx.lineTo(x + size, y + h/2); // base direita
    ctx.lineTo(x - size, y + h/2); // base esquerda
    ctx.closePath();

    ctx.fillStyle = color;
    ctx.fill();
    ctx.strokeStyle = "#000";
    ctx.lineWidth = 2;
    ctx.stroke();
  }

  function drawAlertTriangle(x, y, r, bgColor, tipo) {
    // geometria equilibrada
    const halfH = r * 0.9;
    const halfW = r * 1.0;

    ctx.beginPath();
    ctx.moveTo(x,        y - halfH); // v√©rtice superior
    ctx.lineTo(x + halfW, y + halfH);
    ctx.lineTo(x - halfW, y + halfH);
    ctx.closePath();

    ctx.fillStyle = bgColor;
    ctx.fill();

    ctx.strokeStyle = "#000";
    ctx.lineWidth = 2;
    ctx.stroke();

    // cor do s√≠mbolo
    const exclColor = (tipo === 'viajada') ? "#fff" : "#000";
    ctx.fillStyle = exclColor;

    // tamanho proporcional
    const fontSize = r * 1.6;
    ctx.font = `${fontSize}px Arial`;
    ctx.textAlign = "center";
    ctx.textBaseline = "top";

    // coordenada do topo interno do tri√¢ngulo
    const triTopY = y - halfH;

    // deslocamento ideal: 1px + metade da altura do s√≠mbolo
    const textY = triTopY + 0.3 + (fontSize * 0.25);

    ctx.fillText("!", x, textY);
  }

  /* UI */
  function updateUI(){
    updateList();
    updateStats();
  }

  function updateList(){
    pointsList.innerHTML='';
    points.forEach((p,i)=>{
      const div = document.createElement('div');
      div.className = 'point-row';

      const frase = `#${i+1} ${p.tipoBP || ''} ${p.tipo || ''} ${p.situacao || ''}`.trim();
      const icons = [];
      if (p.finalizou) icons.push("üéØ");
      if (p.teveGol) icons.push("‚öΩ");

      div.innerHTML = `
        <div class="main-line">
          <span>${frase} ${icons.join(' ')}</span>
          <div class="row-actions">
            <button class="btn-small" onclick="openModalEdit(${i})">Editar</button>
            <button class="btn-small" onclick="points.splice(${i},1);render()">Excluir</button>
          </div>
        </div>
        <div class="coords">x:${p.x.toFixed(0)} y:${p.y.toFixed(0)}</div>
      `;

      pointsList.append(div);
    });
  }

  function renderStatFilter(group, label, count, internalValue = label){
    ensureGroup(group);
    const value = internalValue;
    const active = statFilters[group].has(String(value));
    const cls = active ? "stat-checkbox active" : "stat-checkbox";

    return `
  <div class="stat-line">
    <span class="stat-text">${label}: ${count}</span>
    <input type="checkbox"
      class="stat-check"
      data-group="${group}"
      data-val="${value}"
      ${active ? "checked" : ""}
    >
  </div>`;


  }


  function bindStatCheckboxEvents(){
    statsPanel.querySelectorAll(".stat-check").forEach(el=>{
      el.onclick = (ev)=>{
        const group = el.dataset.group;
        const value = el.dataset.val;
        ensureGroup(group);

        if(el.checked){
          statFilters[group].add(String(value));
        } else {
          statFilters[group].delete(String(value));
        }

        render();
      };
    });
  }


  function updateStats(){
    if(points.length===0){
      statsPanel.textContent="Nenhum dado";
      drawStatsChart(0,0);
      return;
    }

    // ===== LABELS PARA VISUALIZA√á√ÉO =====
    const LABEL = {
      finalizou:{ true:"Finalizou", false:"N√£o finalizou" },
      finalForaArea:{ true:"Fora da √°rea" },
      teveGol:{ true:"Gol" },
      cobFora:{ true:"Cobran√ßa fora do campo" },
      falha:{ sim:"Falha" },
    };

    const total=points.length;
    const importCSV = document.getElementById('importCSV');

    const tipoBPCount=countBy(points,'tipoBP');
    const tipo=countBy(points,'tipo');
    const lado=countBy(points,'lado');
    const abertura=countBy(points,'abertura');
    const situacao=countBy(points,'situacao');
    const primeiroContato=countBy(points,'primeiroContato');
    const segundaBola=countBy(points,'segundaBola');
    const finalizacaoTipo=countBy(points,'finalizacaoTipo');
    const qualidadeChance=countBy(points,'qualidadeChance');
    const altura=countBy(points,'altura');
    const resultadoJogada=countBy(points,'resultadoJogada');
    const falha=countBy(points,'falha');

    const finalizouSim=points.filter(p=>p.finalizou===true).length;
    const finalizouNao=points.filter(p=>p.finalizou===false).length;
    const finalForaArea=points.filter(p=>p.finalForaArea===true).length;
    const finalDentroArea=points.filter(p=>p.finalizou===true && p.finalForaArea!==true).length;

    const gols=points.filter(p=>p.teveGol===true).length;
    const claras=points.filter(p=>p.qualidadeChance==='clara').length;
    const falhasSim=points.filter(p=>p.falha==='sim').length;
    const segundaNossa=points.filter(p=>p.segundaBola==='nossa').length;
    const segundaAdv=points.filter(p=>p.segundaBola==='adversario').length;
    const cobrancaFora=points.filter(p=>p.cobFora===true).length;

    statsPanel.innerHTML=
  `
  <div class="stats-grid">

    <div class="stats-block">
      <b>Bola parada</b>
      ${renderStatFilter("tipoBP","escanteio",tipoBPCount.escanteio||0)}
      ${renderStatFilter("tipoBP","faltaIndireta",tipoBPCount.faltaIndireta||0)}
    </div>

    <div class="stats-block">
      <b>Situa√ß√£o</b>
      ${renderStatFilter("situacao","ofensiva",situacao.ofensiva||0)}
      ${renderStatFilter("situacao","defensiva",situacao.defensiva||0)}
    </div>

    <div class="stats-block">
      <b>Tipo da cobran√ßa</b>
      ${renderStatFilter("tipo","viajada",tipo.viajada||0)}
      ${renderStatFilter("tipo","rapida",tipo.rapida||0)}
      ${renderStatFilter("tipo","curta",tipo.curta||0)}
    </div>

    <div class="stats-block">
      <b>Abertura</b>
      ${renderStatFilter("abertura","aberta",abertura.aberta||0)}
      ${renderStatFilter("abertura","fechada",abertura.fechada||0)}
    </div>

    <div class="stats-block">
      <b>Lado</b>
      ${renderStatFilter("lado","direito",lado.direito||0)}
      ${renderStatFilter("lado","esquerdo",lado.esquerdo||0)}
      ${renderStatFilter("lado","central",lado.central||0)}
    </div>

    <div class="stats-block">
      <b>1¬∫ Contato</b>
      ${renderStatFilter("primeiroContato","nosso",primeiroContato.nosso||0)}
      ${renderStatFilter("primeiroContato","adversario",primeiroContato.adversario||0)}
      ${renderStatFilter("primeiroContato","goleiro",primeiroContato.goleiro||0)}
    </div>

    <div class="stats-block">
      <b>Finaliza√ß√µes</b>
      ${renderStatFilter("finalizou", LABEL.finalizou.true, finalizouSim, "true")}
      ${renderStatFilter("finalizou", LABEL.finalizou.false, finalizouNao, "false")}
      ${renderStatFilter("finalForaArea", LABEL.finalForaArea.true, finalForaArea, "true")}
      ${renderStatFilter("resultadoJogada","noGol",resultadoJogada.noGol||0)}
      ${renderStatFilter("resultadoJogada","fora",resultadoJogada.fora||0)}
    </div>

    <div class="stats-block">
      <b>Qualidade</b>
      ${renderStatFilter("qualidadeChance","clara",qualidadeChance.clara||0)}
      ${renderStatFilter("qualidadeChance","boa",qualidadeChance.boa||0)}
      ${renderStatFilter("qualidadeChance","ruim",qualidadeChance.ruim||0)}
    </div>

    <div class="stats-block">
      <b>Altura</b>
      ${renderStatFilter("altura","rasteira",altura.rasteira||0)}
      ${renderStatFilter("altura","media",altura.media||0)}
      ${renderStatFilter("altura","alta",altura.alta||0)}
    </div>

    <div class="stats-block">
      <b>Resultado</b>
      ${renderStatFilter("resultadoJogada","contraAtaque",resultadoJogada.contraAtaque||0)}
      ${renderStatFilter("resultadoJogada","bloqueada",resultadoJogada.bloqueada||0)}
      ${renderStatFilter("resultadoJogada","corte",resultadoJogada.corte||0)}
      ${renderStatFilter("resultadoJogada","nada",resultadoJogada.nada||0)}
    </div>

    <div class="stats-block">
      <b>Eventos cr√≠ticos</b>
      ${renderStatFilter("teveGol", LABEL.teveGol.true, gols, "true")}
      ${renderStatFilter("qualidadeChance","clara",claras,"clara")}
      ${renderStatFilter("falha", LABEL.falha.sim, falhasSim, "sim")}
      ${renderStatFilter("cobFora", LABEL.cobFora.true, cobrancaFora, "true")}
    </div>

    <div class="stats-block">
      <b>2¬™ bola</b>
      ${renderStatFilter("segundaBola","nossa",segundaNossa,"nossa")}
      ${renderStatFilter("segundaBola","adversario",segundaAdv,"adversario")}
    </div>

  </div>
  `;

    bindStatCheckboxEvents();
    drawStatsChart(finalizouSim,finalizouNao);
  }

  function countBy(arr,key){
    return arr.reduce((acc,o)=>{
      const v=o[key];
      acc[v]=(acc[v]||0)+1;
      return acc;
    },{});
  }

  /* BUTTONS */
  btnClear.onclick = ()=>{
    if(confirm('Confirmar limpar todos os pontos?')){
      resetAllState();
    }
  };

  btnUndo.onclick = ()=>{
    if(points.length === 0) return;

    points.pop();

    if(points.length === 0){
      resetAllState();
    } else {
      render();
    }
  };

  filterSelect.onchange=e=>{filterShow=e.target.value;render();};
  filterBPSelect.onchange=e=>{filterBP=e.target.value;render();}; // NOVO
  filterLadoSelect.onchange=e=>{
    filterLado=e.target.value;
    render();
  };
  btnHeatmapToggle.onclick=()=>{
    heatmapOn=!heatmapOn;
    btnHeatmapToggle.textContent=heatmapOn?'Heatmap: ON':'Heatmap: OFF';
    render();
  };

  btnExportCSV.onclick = ()=>{
    let csv = "x,y,tipoBP,tipo,lado,abertura,primeiroContato,segundaBola,quemCobrou,situacao,cobFora,teveGol,finalizou,teveFalha,finalizacaoTipo,qualidadeChance,altura,finalForaArea,resultadoJogada,goalX,goalY,quemFinalizou,falha\n";

    points.forEach(p=>{
      csv += [
        p.x,
        p.y,
        p.tipoBP || '',
        p.tipo || '',
        p.lado || '',
        p.abertura || '',
        p.primeiroContato || '',
        p.segundaBola || '',
        p.quemCobrou || '',
        p.situacao || '',
        p.cobFora ? "true" : "false",
        p.teveGol ? "true" : "false",
        p.finalizou ? "true" : "false",
        p.teveFalha ? "true" : "false",
        p.finalizacaoTipo || '',
        p.qualidadeChance || '',
        p.altura || '',
        p.finalForaArea ? "true" : "false",
        p.resultadoJogada || '',
        p.goalPoint ? p.goalPoint.x : '',
        p.goalPoint ? p.goalPoint.y : '',
        p.quemFinalizou || '',
        p.falha || ''
      ].join(",") + "\n";
    });

    const blob = new Blob([csv], { type:'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'bolas_completo.csv';
    a.click();
  };

  importCSV.addEventListener('change', e=>{
    const files = Array.from(e.target.files);
    if(files.length === 0) return;

    files.forEach(file=>{
      const reader = new FileReader();
      reader.onload = evt=>{
        const lines = evt.target.result.trim().split('\n');
        const header = lines.shift().split(',');

        lines.forEach(line=>{
          const cols = line.split(',');
          if(cols.length < header.length) return;

          const data = {};
          header.forEach((h,i)=> data[h] = cols[i]);

          const goalX = data.goalX ? Number(data.goalX) : null;
          const goalY = data.goalY ? Number(data.goalY) : null;

          points.push({
            x: Number(data.x),
            y: Number(data.y),
            tipoBP: data.tipoBP || 'escanteio',
            tipo: data.tipo,
            cor: COLORS[data.tipo] || '#000',
            lado: data.lado,
            abertura: data.abertura,
            primeiroContato: data.primeiroContato,
            segundaBola: data.segundaBola,
            quemCobrou: data.quemCobrou,
            situacao: data.situacao,
            cobFora: data.cobFora === "true",
            teveGol: data.teveGol === "true",
            finalizou: data.finalizou === "true",
            teveFalha: data.teveFalha === "true",
            finalizacaoTipo: data.finalizacaoTipo,
            qualidadeChance: data.qualidadeChance,
            altura: data.altura,
            finalForaArea: data.finalForaArea === "true",
            resultadoJogada: data.resultadoJogada,
            quemFinalizou: data.quemFinalizou || '',
            falha: data.falha,

            // ‚úÖ COORDENADA DO GOL CORRETA
            goalPoint: (goalX !== null && goalY !== null)
              ? { x: goalX, y: goalY }
              : null
          });
        });

        render();
        importCSV.value = '';
      };

      reader.readAsText(file);
    });
  });

  btnExportPNG.onclick=()=>{

    const o=document.createElement('canvas');
    o.width=canvas.width;
    o.height=canvas.height;
    const ox=o.getContext('2d');

    // fundo
    ox.drawImage(img,0,0);

    // === FILTRA PONTOS VIS√çVEIS ===
    const vis = points.filter(p=>{
      if(filterShow==='ofensivo' && p.situacao!=='ofensiva') return false;
      if(filterShow==='defensivo' && p.situacao!=='defensiva') return false;
      if(filterBP!=='all' && p.tipoBP!==filterBP) return false;
      return true;
    });

    // === HEATMAP PARA EXPORTA√á√ÉO ===
    if(heatmapOn){
      const hcounts = HEAT_REGIONS.map(r=>({
        r,
        count: vis.filter(p=>p.x>=r.x1 && p.x<=r.x2 && p.y>=r.y1 && p.y<=r.y2).length
      }));

      const hmax = Math.max(...hcounts.map(c=>c.count));

      if(hmax>0){
        hcounts.forEach(({r,count})=>{
          const a = (count/hmax)*0.8 + 0.1;
          ox.fillStyle = `rgba(0,80,200,${a})`;
          ox.fillRect(r.x1, r.y1, r.x2-r.x1, r.y2-r.y1);

          ox.fillStyle='white';
          ox.font='bold 22px Arial';
          ox.textAlign='center';
          ox.textBaseline='middle';
          ox.fillText(count, r.x1+(r.x2-r.x1)/2, r.y1+(r.y2-r.y1)/2);
        });
      }
    }

    // === PONTOS VIS√çVEIS ===
    vis.forEach(p=>{
    ox.lineWidth = 2;

    // === COBRAN√áA PARA FORA ‚Äì PRIORIT√ÅRIO ===
    if (p.cobFora) {
      ox.strokeStyle = "#cc0000";
      ox.lineWidth = 6;
      ox.beginPath();
      ox.moveTo(p.x - 10, p.y - 10);
      ox.lineTo(p.x + 10, p.y + 10);
      ox.moveTo(p.x + 10, p.y - 10);
      ox.lineTo(p.x - 10, p.y + 10);
      ox.stroke();
      return; // N√ÉO DESENHA MAIS NADA
    }

    // === TEVE GOL ===
    if (p.teveGol) {
      ox.fillStyle = p.cor;
      ox.strokeStyle = "#000";
      ox.beginPath();
      ox.moveTo(p.x,p.y-12);
      ox.lineTo(p.x+12*0.3,p.y-12*0.3);
      ox.lineTo(p.x+12,p.y);
      ox.lineTo(p.x+12*0.3,p.y+12*0.3);
      ox.lineTo(p.x,p.y+12);
      ox.lineTo(p.x-12*0.3,p.y+12*0.3);
      ox.lineTo(p.x-12,p.y);
      ox.lineTo(p.x-12*0.3,p.y-12*0.3);
      ox.closePath();
      ox.fill(); ox.stroke();
    }

    // === CHANCE CLARA ===
    else if (p.qualidadeChance === 'clara') {
      drawAlertTrianglePNG(ox, p.x, p.y, 12, CLARA_COLORS[p.tipo]);
    }

    // === CASO NORMAL ===
    else {
      ox.fillStyle = p.cor;
      ox.strokeStyle = p.finalizou ? "#000" : "transparent";
      ox.beginPath();
      ox.arc(p.x,p.y,10,0,Math.PI*2);
      ox.fill(); ox.stroke();
    }

    // === LETRA D/E/C (menos no tri√¢ngulo com clara) ===
    if(p.qualidadeChance !== 'clara'){
      ox.font='10px Arial';
      ox.fillStyle='white';
      ox.textAlign='center';
      ox.textBaseline='middle';
      const letra = p.lado ? p.lado[0].toUpperCase() : '';
      ox.fillText(letra,p.x,p.y);
    }
  });

    function drawAlertTriangle(x, y, r, bgColor) {
    const h = r * 1.5; // tri√¢ngulo mais alto para cortar "p√©"

    // Tri√¢ngulo
    ctx.beginPath();
    ctx.moveTo(x, y - h * 0.52);      // topo
    ctx.lineTo(x + r, y + h * 0.48);  // base direita
    ctx.lineTo(x - r, y + h * 0.48);  // base esquerda
    ctx.closePath();

    ctx.fillStyle = bgColor;
    ctx.fill();
    ctx.strokeStyle = "#000";
    ctx.lineWidth = 2;
    ctx.stroke();

    // Cor da exclama√ß√£o
    let exclColor = "#000";
    if (bgColor === CLARA_COLORS.viajada) exclColor = "#fff";

    // Ajuste fino da posi√ß√£o do "!"
    ctx.fillStyle = exclColor;
    ctx.font = `${r * 1.45}px Arial`;
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";

    // deslocamento leve para cima (remove "p√©" visual)
    ctx.fillText("!", x, y - (h * 0.10));
  }


    // === EXPORTA PNG ===
    o.toBlob(b=>{
      const url=URL.createObjectURL(b);
      const a=document.createElement('a');
      a.href=url;
      a.download='mapa.png';
      a.click();
    });

  };

  function drawAlertTrianglePNG(ox, x, y, r, bgColor) {
    const h = r * 1.5;

    ox.beginPath();
    ox.moveTo(x, y - h * 0.52);
    ox.lineTo(x + r, y + h * 0.48);
    ox.lineTo(x - r, y + h * 0.48);
    ox.closePath();

    ox.fillStyle = bgColor;
    ox.fill();
    ox.strokeStyle = "#000";
    ox.lineWidth = 2;
    ox.stroke();

    let exclColor = "#000";
    if (bgColor === CLARA_COLORS.viajada) exclColor = "#fff";

    ox.fillStyle = exclColor;
    ox.font = `${r * 1.45}px Arial`;
    ox.textAlign = "center";
    ox.textBaseline = "middle";
    ox.fillText("!", x, y - (h * 0.10));
  }


  window.openModalEdit=openModalEdit;
  </script>

<div id="overlayHelp" class="overlay">
  <div class="modal" style="width:600px; max-width:90%;">
    <div class="header">Guia de uso do sistema</div>

    <div class="tab-content active" style="display:block; padding:16px; font-size:14px; line-height:1.45;">
      <b>Objetivo do software</b><br>
      Ferramenta para an√°lise de bolas paradas, permitindo registro, filtragem, exporta√ß√£o e avalia√ß√£o t√°tica.
      <br>

      <b><br>‚ö†Ô∏è IMPORTANTE: O SISTEMA N√ÉO ARMAZENA OS EVENTOS AP√ìS RECARREGAR A P√ÅGINA OU SAIR DO NAVEGADOR. SE PRECISAR PAUSAR OU ENCERRAR O TRABALHO, UTILIZE "EXPORTAR CSV" PARA SALVAR O PROGRESSO E PODER RETOMAR POSTERIORMENTE IMPORTANDO O ARQUIVO NOVAMENTE.</b>

      <br><br><b>Como registrar um evento</b>
      <ul style="margin:6px 0;">
        <li>Clique no mapa principal para criar um ponto.</li>
        <li>Preencha informa√ß√µes de cobran√ßa, lado, primeiro contato, resultado, etc.</li>
        <li>Salvar registra o evento na base interna.</li>
      </ul>

      <b>Como editar/remover eventos</b>
      <ul style="margin:6px 0;">
        <li>Clique em uma bolinha j√° existente ‚Üí abre modal de edi√ß√£o.</li>
        <li>Listagem lateral permite editar/excluir rapidamente.</li>
      </ul>

      <b>Filtragem e visualiza√ß√£o</b>
      <ul style="margin:6px 0;">
        <li><b>Mostrar</b>: ofensivo / defensivo / ambos.</li>
        <li><b>BP</b>: escanteio / falta indireta.</li>
        <li><b>Lado</b>: direito / esquerdo / central.</li>
        <li><b>Heatmap</b>: ON/OFF para visualizar densidade de a√ß√µes.</li>
      </ul>

      <b>Estat√≠sticas</b>
      <ul style="margin:6px 0;">
        <li>Contagem autom√°tica por tipo de cobran√ßa, lado, resultados.</li>
        <li>Checkboxs criam filtros internos avan√ßados.</li>
        <li>Jogadores e cobradores possuem ranking autom√°tico.</li>
      </ul>

      <b>Como funciona a Tomada de Decis√£o</b>
      <ul style="margin:6px 0;">
        <li>Baseia-se em volume (quantidade) + efici√™ncia (gols, finaliza√ß√µes, 1¬∫ contato) + risco (transi√ß√µes).</li>
        <li>Ofensivo considera: gols, finaliza√ß√µes, 1¬∫ contato, continuidade.</li>
        <li>Defensivo considera: gols sofridos, finaliza√ß√µes contra, transi√ß√µes.</li>
        <li>Recomenda prioriza√ß√£o com base estat√≠stica, n√£o opini√£o.</li>
      </ul>

      <b>Exporta√ß√£o</b>
      <ul style="margin:6px 0;">
        <li>Exportar CSV ‚Üí exporta tabela bruta com todos os eventos.</li>
        <li>Importar CSV ‚Üí importa tabela bruta com todos os eventos j√° feitos.</li>
        <li>Exportar PNG/PDF ‚Üí representa√ß√£o visual + relat√≥rios.</li>
      </ul>
    </div>

    <div class="actions">
      <button id="btnHelpClose" class="btn-small" style="background-color: red; color: white;">Entendi</button>
    </div>
  </div>
</div>

  <script>


  document.getElementById('btnClearStatsFilters').onclick = ()=>{
  statFilters = {};
  filterCobradores.clear();   // üëà NOVO
  filterJogadores.clear();    // üëà NOVO
  render();
};
  function togglePointsList(){
    const panel = document.getElementById('pointsPanel');
    const icon = document.getElementById('pointsToggle');

    if(panel.style.display === 'none'){
      panel.style.display = 'block';
      icon.textContent = '‚ñº';
    } else {
      panel.style.display = 'none';
      icon.textContent = '‚ñ≤';
    }
  }

  const goalViewCanvas = document.getElementById('goalViewCanvas');
  const gvctx = goalViewCanvas.getContext('2d');
  const goalViewImg = new Image();



  goalViewImg.src = 'gol.jpeg';

  goalViewImg.onload = ()=> renderGoalView();

  function renderGoalView(){
    if(!goalViewImg.complete) return;

    gvctx.clearRect(0,0,goalViewCanvas.width,goalViewCanvas.height);
    gvctx.drawImage(goalViewImg,0,0,goalViewCanvas.width,goalViewCanvas.height);

    // üîí CLIP ‚Äî NADA FORA DO GOL
    gvctx.save();
    gvctx.beginPath();
    gvctx.rect(
      GOAL_AREA.x,
      GOAL_AREA.y,
      GOAL_AREA.width,
      GOAL_AREA.height
    );
    gvctx.clip();

    const vis = getVisiblePoints().filter(p=>p.goalPoint);

    // === HEATMAP DO GOL ===
    if(heatmapOn){
      drawGoalHeatmap(vis);
    }

    // === MARCADORES ===
    vis.forEach(p=>{
      const { x, y } = p.goalPoint;

      // seguran√ßa extra
      if(
        x < GOAL_AREA.x ||
        x > GOAL_AREA.x + GOAL_AREA.width ||
        y < GOAL_AREA.y ||
        y > GOAL_AREA.y + GOAL_AREA.height
      ) return;

      if(p.resultadoJogada === 'gol'){
        gvctx.font = 'bold 12px Arial';
        gvctx.textAlign = 'center';
        gvctx.textBaseline = 'middle';
        gvctx.fillText('‚öΩ', x, y);
      }

      else if(p.resultadoJogada === 'noGol'){
        gvctx.fillStyle = '#16A34A';
        gvctx.beginPath();
        gvctx.arc(x, y, 5, 0, Math.PI*2);
        gvctx.fill();
      }
    });

    gvctx.restore(); // üîì libera canvas
  }

  finalizou.onchange = ()=>{
    if(finalizou.checked){
      enableTab('tab-final');
      rowQuemFinalizou.style.display = 'flex';
    } else {
      rowQuemFinalizou.style.display = 'none';
      quemFinalizou.value = '';
    }
  };


  teveFalha.onchange = ()=>{
    if(teveFalha.checked){
      enableTab('tab-avanc');
    }
  };

  function updateResultadoOptions(){
    const opts = Array.from(resultadoJogada.options);

    // esconde tudo
    opts.forEach(o => o.style.display = 'none');

    // limpa valor se ficar inv√°lido
    resultadoJogada.value = '';

    // ===== CASO 1: TEVE GOL =====
    if(teveGol.checked){
      resultadoJogada.querySelector('option[value="gol"]').style.display = 'block';
      return;
    }

    // ===== CASO 2: FINALIZOU (SEM GOL) =====
    if(finalizou.checked){
      ['bloqueada','fora','noGol'].forEach(v=>{
        const opt = resultadoJogada.querySelector(`option[value="${v}"]`);
        if(opt) opt.style.display = 'block';
      });
      return;
    }

    // ===== CASO 3: NENHUM MARCADO =====
    ['contraAtaque','corte','nada'].forEach(v=>{
      const opt = resultadoJogada.querySelector(`option[value="${v}"]`);
      if(opt) opt.style.display = 'block';
    });
  }

  /* ===== EVENTS ===== */
  teveGol.onchange = ()=>{
    if(teveGol.checked){
      finalizou.checked = true;
      enableTab('tab-final');
      rowQuemFinalizou.style.display = 'flex';
    }
    updateResultadoOptions();
  };

  finalizou.onchange = ()=>{
    if(finalizou.checked){
      enableTab('tab-final');
      rowQuemFinalizou.style.display = 'flex';
    } else {
      rowQuemFinalizou.style.display = 'none';
      quemFinalizou.value = '';
      teveGol.checked = false;
    }
    updateResultadoOptions();
  };



  /* ===== RESULTADO CHANGE ===== */
  resultadoJogada.onchange = ()=>{
    const ativo =
      resultadoJogada.value === 'gol' ||
      resultadoJogada.value === 'noGol';

    goalEditWrapper.style.display = ativo ? 'block' : 'none';

    if(ativo){
      enableTab('tab-resultado');
      renderGoalEdit();
    }

    if(heatmapOn){
      drawGoalHeatmap();
    }
  };






  const goalEditCanvas = document.getElementById('goalEditCanvas');
  const gectx = goalEditCanvas.getContext('2d');
  const goalEditImg = new Image();
  goalEditImg.src = 'gol.jpeg';

  let tempGoalPoint = null;
  const goalEditWrapper = document.getElementById('goalEditWrapper');
  let savedGoalPoint = null;
  let savedGoalResult = null;


  function renderGoalEdit(){
    gectx.clearRect(0,0,goalEditCanvas.width,goalEditCanvas.height);
    gectx.drawImage(goalEditImg,0,0,goalEditCanvas.width,goalEditCanvas.height);

    if(tempGoalPoint){
      gectx.fillStyle='#cc0000';
      gectx.beginPath();
      gectx.arc(tempGoalPoint.x,tempGoalPoint.y,6,0,Math.PI*2);
      gectx.fill();
    }
  }

  goalEditCanvas.onclick = e=>{
    tempGoalPoint = {
      x: e.offsetX,
      y: e.offsetY
    };
    renderGoalEdit();
  };

  function clipGoalMouth(ctx){
    ctx.save();
    ctx.beginPath();

    // canto inferior esquerdo
    ctx.moveTo(GOAL_AREA.x, GOAL_AREA.y + GOAL_AREA.height);

    // sobe pela trave esquerda
    ctx.lineTo(GOAL_AREA.x, GOAL_AREA.y + 10);

    // curva do travess√£o (topo da rede)
    ctx.quadraticCurveTo(
      GOAL_AREA.x + GOAL_AREA.width / 2, // controle central
      GOAL_AREA.y - 6,                   // levemente acima
      GOAL_AREA.x + GOAL_AREA.width,     // fim
      GOAL_AREA.y + 10
    );

    // desce pela trave direita
    ctx.lineTo(GOAL_AREA.x + GOAL_AREA.width, GOAL_AREA.y + GOAL_AREA.height);

    ctx.closePath();
    ctx.clip();
  }

  // === √ÅREA REAL DA BOCA DO GOL (AJUSTADA √Ä IMAGEM) ===
  const GOAL_AREA = {
    x: 28,      // trave esquerda (colada)
    y: 30,      // topo da rede
    width: 184, // largura exata entre traves
    height: 72  // at√© o ch√£o da rede
  };

  const GOAL_ZONES_3 = [
    { id: 'left',   x1: 0,   x2: 80 },
    { id: 'center', x1: 80,  x2: 160 },
    { id: 'right',  x1: 160, x2: 240 }
  ];


  function drawGoalHeatmap(vis){

    // üî¥ RECORTE REAL DO GOL (REMOVE O EXCEDENTE)
    clipGoalMouth(gvctx);

    const zones = [
      {
        name: 'esquerda',
        x1: GOAL_AREA.x,
        x2: GOAL_AREA.x + GOAL_AREA.width / 3
      },
      {
        name: 'centro',
        x1: GOAL_AREA.x + GOAL_AREA.width / 3,
        x2: GOAL_AREA.x + 2 * GOAL_AREA.width / 3
      },
      {
        name: 'direita',
        x1: GOAL_AREA.x + 2 * GOAL_AREA.width / 3,
        x2: GOAL_AREA.x + GOAL_AREA.width
      }
    ];

    const stats = zones.map(z=>{
      let total = 0;
      let gols = 0;

      vis.forEach(p=>{
        const gp = p.goalPoint;
        if(!gp) return;

        if(
          gp.x >= z.x1 &&
          gp.x <= z.x2 &&
          gp.y >= GOAL_AREA.y &&
          gp.y <= GOAL_AREA.y + GOAL_AREA.height
        ){
          total++;
          if(p.resultadoJogada === 'gol') gols++;
        }
      });

      return { ...z, total, gols };
    });

    const max = Math.max(...stats.map(s=>s.total));
    if(max === 0){
      gvctx.restore();
      return;
    }

    stats.forEach(z=>{
      if(z.total === 0) return;

      const alpha = (z.total / max) * 0.6;
      gvctx.fillStyle = `rgba(22,163,74,${alpha})`;

      gvctx.fillRect(
        z.x1,
        GOAL_AREA.y,
        z.x2 - z.x1,
        GOAL_AREA.height
      );

      gvctx.fillStyle = '#000';
      gvctx.font = 'bold 12px Arial';
      gvctx.textAlign = 'center';
      gvctx.textBaseline = 'bottom';

      gvctx.fillText(
        `${z.gols}/${z.total}`,
        (z.x1 + z.x2) / 2,
        GOAL_AREA.y + GOAL_AREA.height / 2
      );
    });

    gvctx.restore(); // üîì libera o canvas
  }
  function resetAllState(){
    points = [];
    
    pendingClick = null;
    editingIndex = null;
    tempGoalPoint = null;
    savedGoal = null;

    statFilters = {};

    // reset filtros visuais
    filterShow = 'both';
    filterBP = 'all';
    filterLado = 'all';

    document.getElementById('filterShow').value = 'both';
    document.getElementById('filterBP').value = 'all';
    document.getElementById('filterLado').value = 'all';
    importCSV.value = '';

    // limpa canvas do gol
    if(goalViewImg.complete){
      gvctx.clearRect(0,0,goalViewCanvas.width,goalViewCanvas.height);
      gvctx.drawImage(goalViewImg,0,0,goalViewCanvas.width,goalViewCanvas.height);
    }

    render();
    filterCobradores.clear();
    filterJogadores.clear();

  }

  function buildPlayersStats(){
    const cobradores = {};
    const jogadores = {};

    points.forEach(p=>{
      if(!passesStatFilters(p)) return; // üî• FILTRO APLICA AQUI

      /* ========= COBRADORES ========= */
      if(p.quemCobrou){
        if(!cobradores[p.quemCobrou]){
          cobradores[p.quemCobrou] = {
            nome: p.quemCobrou,
            cobrancas: 0,
            primeiroContato: 0,
            finalizacoes: 0,
            gols: 0,
            acionados: {}
          };
        }

        const c = cobradores[p.quemCobrou];
        c.cobrancas++;

        if(p.primeiroContato === 'nosso'){
          c.primeiroContato++;

          if(p.finalizou){
            c.finalizacoes++;
            if(p.quemFinalizou){
              c.acionados[p.quemFinalizou] =
                (c.acionados[p.quemFinalizou] || 0) + 1;
            }
          }

          if(p.teveGol) c.gols++;
        }
      }

      /* ========= JOGADORES ========= */
      if(p.finalizou && p.quemFinalizou){
        if(!jogadores[p.quemFinalizou]){
          jogadores[p.quemFinalizou] = {
            nome: p.quemFinalizou,
            finalizacoes: 0,
            gols: 0,
            duelos: 0
          };
        }

        const j = jogadores[p.quemFinalizou];
        j.finalizacoes++;
        if(p.teveGol) j.gols++;
        if(p.primeiroContato === 'nosso') j.duelos++;
      }
    });

    /* ========= RANKING ========= */
    const rankCobradores = Object.values(cobradores)
      .sort((a,b)=>
        b.gols - a.gols ||
        b.finalizacoes - a.finalizacoes ||
        b.primeiroContato - a.primeiroContato
      );

    const rankJogadores = Object.values(jogadores)
      .sort((a,b)=>
        b.gols - a.gols ||
        b.finalizacoes - a.finalizacoes ||
        b.duelos - a.duelos
      );

    return { rankCobradores, rankJogadores };
  }

  function renderPlayersCards(){
  const { rankCobradores, rankJogadores } = buildPlayersStats();

  const cobDiv = document.getElementById('cobradoresCard');
  const jogDiv = document.getElementById('jogadoresCard');

  cobDiv.innerHTML = rankCobradores.length
    ? rankCobradores.map((c,i)=>{
        const checked = filterCobradores.has(c.nome) ? "checked" : "";
        const mais =
          Object.entries(c.acionados)
            .sort((a,b)=>b[1]-a[1])[0];

        return `
          <div style="display:flex;align-items:flex-start;gap:6px;margin-bottom:6px;">
            <input type="checkbox" class="chk-cobrador" value="${c.nome}" ${checked}>
            <div style="flex:1;">
              <b>${i+1}¬∫ ${c.nome}</b><br>
              Gols: ${c.gols}<br>
              Finaliza√ß√µes: ${c.finalizacoes}<br>
              1¬∫ contato: ${c.primeiroContato}<br>
              ${mais ? `Mais acionou: ${mais[0]} (${mais[1]})` : ''}
            </div>
          </div>
        `;
      }).join('')
    : 'Nenhum dado';

  jogDiv.innerHTML = rankJogadores.length
    ? rankJogadores.map((j,i)=>{
        const checked = filterJogadores.has(j.nome) ? "checked" : "";
        return `
          <div style="display:flex;align-items:flex-start;gap:6px;margin-bottom:6px;">
            <input type="checkbox" class="chk-jogador" value="${j.nome}" ${checked}>
            <div style="flex:1;">
              <b>${i+1}¬∫ ${j.nome}</b><br>
              Gols: ${j.gols}<br>
              Finaliza√ß√µes: ${j.finalizacoes}<br>
              Duelos vencidos: ${j.duelos}
            </div>
          </div>
        `;
      }).join('')
    : 'Nenhum dado';

  bindPlayerCheckboxEvents();
}

function bindPlayerCheckboxEvents(){
  document.querySelectorAll('.chk-cobrador').forEach(chk=>{
    chk.onchange = ()=>{
      if(chk.checked){
        filterCobradores.add(chk.value);
      } else {
        filterCobradores.delete(chk.value);
      }
      render();
    };
  });

  document.querySelectorAll('.chk-jogador').forEach(chk=>{
    chk.onchange = ()=>{
      if(chk.checked){
        filterJogadores.add(chk.value);
      } else {
        filterJogadores.delete(chk.value);
      }
      render();
    };
  });
}
  function renderDecision(){
  const vis = getVisiblePoints();
  const panel = document.getElementById("decisionPanel");

  if(!vis || vis.length === 0){
    panel.innerHTML = "Sem dados suficientes para tomada de decis√£o.";
    return;
  }

  // ============================
  // AGRUPADOR T√ÅTICO
  // ============================
  const key = p => `${p.tipoBP} | ${p.lado} | ${p.tipo}`;
  const groups = {};
  vis.forEach(p=>{
    const k = key(p);
    if(!groups[k]) groups[k]=[];
    groups[k].push(p);
  });

  // ============================
  // AN√ÅLISE T√ÅTICA DE COMBOS
  // ============================
  const analysis = Object.keys(groups).map(k=>{
    const arr = groups[k];
    const ofensivos = arr.filter(p=>p.situacao==='ofensiva');
    const defensivos = arr.filter(p=>p.situacao==='defensiva');

    const qtdOf = ofensivos.length;
    const qtdDef = defensivos.length;

    const gols = ofensivos.filter(p=>p.teveGol).length;
    const fins = ofensivos.filter(p=>p.finalizou).length;
    const duelosOf = ofensivos.filter(p=>p.primeiroContato==='nosso').length;
    const trans = ofensivos.filter(p=>p.resultadoJogada==='contraAtaque').length;

    const golsContra = defensivos.filter(p=>p.resultadoJogada==='gol').length;
    const finsContra = defensivos.filter(p=>p.resultadoJogada==='noGol').length;
    const duelosDef = defensivos.filter(p=>p.primeiroContato==='nosso').length;

    const penalty = (qtdOf <= 2) ? 0.8 : 0;
    const scoreAtaque = (gols * 3) + (fins * 1.2) - penalty;
    const scoreDefesa = (golsContra * 3) + (finsContra * 1.2);

    return {
      combo:k,
      qtdOf,
      qtdDef,
      gols,
      fins,
      duelosOf,
      trans,
      golsContra,
      finsContra,
      duelosDef,
      scoreAtaque,
      scoreDefesa
    };
  });

  // ============================
  // AMOSTRA M√çNIMA
  // ============================
  const minOf = a => a.qtdOf >= 3;
  const minDef = a => a.qtdDef >= 3;

  const ofensivos = analysis.filter(minOf);
  const defensivos = analysis.filter(minDef);

  const piorOf = ofensivos.slice().sort((a,b)=>a.scoreAtaque - b.scoreAtaque)[0];
  const melhorOf = ofensivos.slice().sort((a,b)=>b.scoreAtaque - a.scoreAtaque)[0];
  const trans = ofensivos.slice().sort((a,b)=>b.trans - a.trans)[0];
  const piorDef = defensivos.slice().sort((a,b)=>b.scoreDefesa - a.scoreDefesa)[0];

  const fmt = c=>{
    const [bp,lado,tipo]=c.split('|').map(s=>s.trim());
    return {bp,lado,tipo};
  };

  // ============================
  // ZONAS DO HEAT (SEM FALLBACK)
  // ============================

  const regionsLeft = [
    {name:"Z1",   x1:253, x2:361, y1:40, y2:150},
    {name:"zona", x1:362, x2:465, y1:40, y2:150},
    {name:"Z2",   x1:466, x2:588, y1:40, y2:150}
  ];

  const regionsRight = [
    {name:"Z2",   x1:253, x2:361, y1:40, y2:150},
    {name:"zona", x1:362, x2:465, y1:40, y2:150},
    {name:"Z1",   x1:466, x2:588, y1:40, y2:150}
  ];

  let zonasOf = {Z1:0, zona:0, Z2:0};
  let golsOf  = {Z1:0, zona:0, Z2:0};

  let zonasDef = {Z1:0, zona:0, Z2:0};
  let golsDef  = {Z1:0, zona:0, Z2:0};

  vis.forEach(p=>{
    if(!p.lado) return;

    const regions = (p.lado === "direito") ? regionsRight : regionsLeft;

    for(const r of regions){
      if(p.x>=r.x1 && p.x<=r.x2 && p.y>=r.y1 && p.y<=r.y2){

        // Ofensivo
        if(p.situacao==='ofensiva'){
          if(p.finalizou || p.teveGol) zonasOf[r.name]++;
          if(p.teveGol) golsOf[r.name]++;
        }

        // Defensivo
        if(p.situacao==='defensiva'){
          if(p.finalizou || p.teveGol) zonasDef[r.name]++;
          if(p.teveGol) golsDef[r.name]++;
        }

        break;
      }
    }
  });

  function maior(dict){
    const arr = Object.entries(dict).sort((a,b)=>b[1]-a[1]);
    return arr[0][1] > 0 ? arr[0][0] : "Sem registro";
  }

  const zonaFinalMais = maior(zonasOf);
  const zonaGolMais   = maior(golsOf);
  const zonaFinalSof  = maior(zonasDef);
  const zonaGolSof    = maior(golsDef);

  // ============================
  // FORMATA√á√ÉO DE TEXTO
  // ============================
  const ladoOf = vis.find(p=>p.situacao==='ofensiva' && (p.finalizou||p.teveGol))?.lado || "esquerdo";
  const ladoDef = vis.find(p=>p.situacao==='defensiva')?.lado || "esquerdo";

  function traduzZona(z, lado){
    if(z === "zona") return `Meio (batida do lado ${lado})`;
    if(z === "Z1") return lado==="esquerdo"
      ? "Primeiro poste (batida do lado esquerdo)"
      : "Primeiro poste (batida do lado direito)";
    if(z === "Z2") return lado==="esquerdo"
      ? "Segundo poste (batida do lado esquerdo)"
      : "Segundo poste (batida do lado direito)";
    return "Sem registro";
  }

  const out = [];
  const SP = `style="margin-bottom:2px;"`;

  // ============================
  // SA√çDA T√ÅTICA
  // ============================
  if(piorOf){
    const {bp,lado,tipo}=fmt(piorOf.combo);
    out.push(`<div ${SP}><b>‚úì No que devemos melhorar:</b> Cobran√ßa de ${bp} pelo lado ${lado} com a batida ${tipo}.</div>`);
  }

  if(trans && trans.trans>0){
    const {bp,lado,tipo}=fmt(trans.combo);
    out.push(`<div ${SP}><b>‚ö† Sofremos mais transi√ß√µes:</b> Cobran√ßas de ${bp} pelo lado ${lado} com a batida ${tipo}.</div>`);
  }

  if(melhorOf){
    const {bp,lado,tipo}=fmt(melhorOf.combo);
    out.push(`<div ${SP}><b>üèÅ No que fomos mais eficientes:</b> Cobran√ßas de ${bp} pelo lado ${lado} com a batida ${tipo}.</div>`);
  }

  if(piorDef){
    const {bp,lado,tipo}=fmt(piorDef.combo);
    out.push(`<div ${SP}><b>‚õî Devemos ajustar a defesa em:</b> Cobran√ßas de ${bp} pelo lado ${lado} com a batida ${tipo}.</div>`);
  }

  // ============================
  // SA√çDA ZONAS
  // ============================
  out.push(`<div ${SP}><b>üéØ Zona que mais sofremos finaliza√ß√µes:</b> ${traduzZona(zonaFinalSof, ladoDef)}</div>`);
  out.push(`<div ${SP}><b>‚öΩ Zona que mais sofremos gols:</b> ${traduzZona(zonaGolSof, ladoDef)}</div>`);
  out.push(`<div ${SP}><b>üìå Zona que mais finalizamos:</b> ${traduzZona(zonaFinalMais, ladoOf)}</div>`);
  out.push(`<div ${SP}><b>‚öΩ Zona que mais fizemos gols:</b> ${traduzZona(zonaGolMais, ladoOf)}</div>`);

  // ============================
  // M√âTRICAS CONTEXTO
  // ============================
  const totalOf = vis.filter(p=>p.situacao==='ofensiva').length;
  const totalDef = vis.filter(p=>p.situacao==='defensiva').length;
  const totalFins = vis.filter(p=>p.situacao==='ofensiva' && p.finalizou).length;
  const totalFinsAdv = vis.filter(p=>p.situacao==='defensiva' && p.resultadoJogada==='noGol').length;
  const totalDuelosOf = vis.filter(p=>p.situacao==='ofensiva' && p.primeiroContato==='nosso').length;
  const totalDuelosDef = vis.filter(p=>p.situacao==='defensiva' && p.primeiroContato==='nosso').length;

  out.push(`<br><b>üìä M√©tricas de Contexto:</b>`);
  out.push(`‚Ä¢ Finalizamos em ${(totalFins/totalOf*100).toFixed(1)}% das bolas ofensivas.`);
  out.push(`‚Ä¢ Ganhamos a 1¬™ disputa em ${(totalDuelosOf/totalOf*100).toFixed(1)}% das bolas ofensivas.`);
  out.push(`‚Ä¢ Ganhamos a 1¬™ disputa em ${(totalDuelosDef/totalDef*100).toFixed(1)}% das bolas defensivas.`);
  out.push(`‚Ä¢ Advers√°rio finalizou em ${(totalFinsAdv/totalDef*100).toFixed(1)}% das bolas defensivas.`);

  panel.innerHTML = out.join("<br>");
}


document.getElementById("btnExportPDF").onclick = async () => {
  const { jsPDF } = window.jspdf;

  // CONFIG PDF A2
  const a2WidthPx = Math.round(420 / 25.4 * 96);
  const a2HeightPx = Math.round(594 / 25.4 * 96);

  // BACKUP DO ESTADO
  const stateBackup = {
    show: filterShow,
    bp: filterBP,
    lado: filterLado,
    heat: heatmapOn
  };

  function restoreState(){
    filterShow = stateBackup.show;
    filterBP = stateBackup.bp;
    filterLado = stateBackup.lado;
    heatmapOn = stateBackup.heat;
    document.getElementById('filterShow').value = filterShow;
    document.getElementById('filterBP').value = filterBP;
    document.getElementById('filterLado').value = filterLado;
    render();
  }

  // CAPTURA SOMENTE O CANVAS PRINCIPAL
  async function captureCanvas(){
    const canvasMap = document.getElementById("canvas");
    return new Promise(resolve=>{
      const imgData = canvasMap.toDataURL("image/png", 1.0);
      resolve(imgData);
    });
  }

  // ===== CAPTURAR OS 5 PRINTS NORMAIS =====
  async function captureFull(){
    const canvas = await html2canvas(document.body, { scale:2, useCORS:true, backgroundColor:"#FFFFFF" });
    return canvas.toDataURL("image/jpeg", 0.95);
  }

  // P√ÅGINAS NORMAIS
  filterShow='both'; filterBP='all'; filterLado='all'; render();
  const imgGeral = await captureFull();

  filterShow='ofensivo'; filterBP='escanteio'; filterLado='all'; render();
  const imgOffEsc = await captureFull();

  filterShow='ofensivo'; filterBP='faltaIndireta'; filterLado='all'; render();
  const imgOffFal = await captureFull();

  filterShow='defensivo'; filterBP='escanteio'; filterLado='all'; render();
  const imgDefEsc = await captureFull();

  filterShow='defensivo'; filterBP='faltaIndireta'; filterLado='all'; render();
  const imgDefFal = await captureFull();


  // ===== CAPTURAR HEATMAPS CANVAS-ONLY =====
  heatmapOn = true;

  // 1) GERAL
  filterShow='both'; filterBP='all'; filterLado='all'; render();
  const hGeral = await captureCanvas();

  // 2) OFENSIVO
  filterShow='ofensivo'; filterBP='all'; filterLado='all'; render();
  const hOf = await captureCanvas();

  // 3) DEFENSIVO
  filterShow='defensivo'; filterBP='all'; filterLado='all'; render();
  const hDef = await captureCanvas();

  // RESTAURAR TELA ORIGINAL
  restoreState();

  // =========================
  // MONTAR PDF
  // =========================
  const pdf = new jsPDF({
    unit: "px",
    format: [a2WidthPx, a2HeightPx],
    orientation: "portrait"
  });

  async function addPage(imgData, index, titulo){
    const img = new Image();
    return new Promise(resolve=>{
      img.onload = ()=>{
        const imgRatio = img.width / img.height;
        const pageRatio = a2WidthPx / a2HeightPx;
        let w,h;

        if(imgRatio > pageRatio){
          w = a2WidthPx;
          h = a2WidthPx / imgRatio;
        } else {
          h = a2HeightPx * 0.88;
          w = h * imgRatio;
        }

        if(index > 0) pdf.addPage();

        pdf.setFontSize(32);
        pdf.setFont("helvetica", "bold");
        pdf.text(titulo, a2WidthPx / 2, 60, { align: "center" });

        pdf.addImage(
          imgData,
          "JPEG",
          (a2WidthPx - w) / 2,
          120,
          w,
          h
        );

        resolve();
      };
      img.src = imgData;
    });
  }

  // P√ÅGINAS NORMAIS
  await addPage(imgGeral,   0, "GERAL");
  await addPage(imgOffEsc,  1, "OFENSIVO ‚Äî ESCANTEIO");
  await addPage(imgOffFal,  2, "OFENSIVO ‚Äî FALTA INDIRETA");
  await addPage(imgDefEsc,  3, "DEFENSIVO ‚Äî ESCANTEIO");
  await addPage(imgDefFal,  4, "DEFENSIVO ‚Äî FALTA INDIRETA");

  // ===== P√ÅGINA EXTRA HEATMAP =====
  pdf.addPage();

  const heatImgs = [
    {title:"GERAL", img:hGeral},
    {title:"OFENSIVO", img:hOf},
    {title:"DEFENSIVO", img:hDef}
  ];

  pdf.setFontSize(28);
  pdf.setFont("helvetica", "bold");
  pdf.text("HEATMAP ‚Äî √ÅREAS DE CONCENTRA√á√ÉO", a2WidthPx/2, 50, {align:"center"});

  const blockWidth = a2WidthPx / 3;
  const imgWidth = blockWidth * 0.85;
  const imgHeight = imgWidth * 0.5;

  heatImgs.forEach((obj,idx)=>{
    const x = blockWidth * idx + (blockWidth - imgWidth)/2;
    const y = 140;

    pdf.setFontSize(22);
    pdf.text(obj.title, x + imgWidth/2, y - 10, {align:"center"});

    pdf.addImage(obj.img, "PNG", x, y, imgWidth, imgHeight);
  });

  pdf.save("Analise_Bolas_Paradas.pdf");
};


const overlayHelp = document.getElementById("overlayHelp");
const btnHelp = document.getElementById("btnHelp");
const btnHelpClose = document.getElementById("btnHelpClose");

// abre modal
btnHelp.onclick = () => {
  overlayHelp.style.display = "flex";
};

// fecha modal
btnHelpClose.onclick = () => {
  overlayHelp.style.display = "none";
};

overlayHelp.onclick = (e)=>{
  if(e.target === overlayHelp){
    overlayHelp.style.display = "none";
  }
};

// ===== FIRST-TIME HELP MODAL USING LOCALSTORAGE =====
(function(){
  const LS_KEY = "bp_help_seen_v1";

  // se nunca viu, abre e grava
  if(!localStorage.getItem(LS_KEY)){
    overlayHelp.style.display = "flex";
    localStorage.setItem(LS_KEY, "1");
  }
})();






  </script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<footer id="appFooter">
  ¬© 2026<span id="footerYear"></span> ‚Äî Desenvolvido por @felipeerabelo_   . 
  <a href="https://www.instagram.com/felipeerabelo_?igsh=Y281aGMxN2Y0am8=" target="_blank"
     style="display:inline-flex;align-items:center;gap:6px;color:inherit;text-decoration:none;">
     <svg width="16" height="16" viewBox="0 0 256 256" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
       <rect width="256" height="256" rx="60" fill="none" stroke="currentColor" stroke-width="20"/>
       <circle cx="128" cy="128" r="50" fill="none" stroke="currentColor" stroke-width="20"/>
       <circle cx="180" cy="76" r="14" fill="currentColor"/>
     </svg>
     
  </a>
</footer>





  </body>
  </html>
